name: DEBUG - Test Combine Job

on:
  workflow_dispatch: #只允许手动触发

jobs:
  #跳过 prepare 和 process 任务，测试 combine
  
  combine:
    #移除了 needs: process，让其独立运行
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.8

      #创建假的 process 产物
      #模拟 download-artifact 步骤，否则后续脚本会因找不到文件而失败
      - name: Create fake artifacts for testing
        run: |
          mkdir -p processed-chunk-1
          echo '[]' > processed-chunk-1/takeout-part-1.json
          mkdir -p base-data
          echo '{}' > base-data/user.json
      #模拟步骤结束

      #诊断目标
      - name: 1. Run Diagnostics and Install Dependencies
        run: |
          echo "--- 1.1. Verifying file structure ---"
          pwd
          ls -lR

          echo "--- 1.2. Verifying contents of requirements.txt ---"
          cat requirements.txt

          echo "--- 1.3. Installing dependencies ---"
          pip install -r requirements.txt

          echo "--- 1.4. Verifying installed packages (This is the most important step!) ---"
          pip list
      #诊断步骤结束

      # 后续步骤运行，看看错误是否复现
      - name: 2. (Step 3a) Combine all chunks
        run: python combine.py
      
      - name: 3. (Step 3b) Build HTML
        run: python generate_html.py
      
      - name: 4. (Step 3c) Build CSV
        run: python generate_csv.py
